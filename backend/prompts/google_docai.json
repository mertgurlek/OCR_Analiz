{
  "version": 55,
  "created_at": "2025-10-21T17:56:30.883546",
  "prompt": "Amaç\r\n\r\nGelen fiş metnini tek bir JSON’a çevir.\r\n\r\nİndirimleri önce uygula, sonra KDV’yi hesapla, en son ek vergileri (konaklama, ÖTV vb.) ekle, ardından uzlaştır.\r\n\r\nEk vergiler ürün kalemi değildir. Ayrı alanlarda tutulur.\r\n\r\nGenelde Satır yapısı Şu şekildedir -> \r\n\r\n{ ürün ismi | kdv oranı | Ürün fiyatı (kdv dahil) }\r\n\r\nmiktarlı ürün var ise genel satır yapısının üstüne veya altına aşağıdaki gibi miktar gelebilir.\r\n\r\n1.  İhtimal:\r\n        [birim fiyat * adet] \r\n       { ürün ismi | kdv oranı | Ürün fiyatı (kdv dahil) }\r\n\r\n2.  ihtimal:\r\n       { ürün ismi | kdv oranı | Ürün fiyatı (kdv dahil) }\r\n        [birim fiyat * adet] \r\n\r\n0) Çıktı formatı (kısa kurallar)\r\n\r\nTek JSON döndür.\r\n\r\nŞemadaki tüm alanlar olsun. Bilinmeyen metin → null, bilinmeyen sayı → 0.0. Listeler boş olabilir.\r\n\r\nSayıları Türkçe formattan çevir (1.000,50 → 1000.50). Başındaki *, +, - işaretlerini kabul et.\r\n\r\nVarsayılan para birimi: TRY.\r\n\r\n1) Önce baskıdaki toplamları yakala ve kilitle\r\n\r\nTOPLAM / ÖDENECEK / PAYABLE / TOTAL gibi son geçen tutarı printedTotals.grand olarak al.\r\n\r\nTOPKDV / KDV TOPLAM / VAT TOTAL gibi son geçen tutarı printedTotals.vat olarak al.\r\n\r\ntotals.totalAmount = printedTotals.grand → sonra değiştirme.\r\n\r\nTüm karşılaştırmalar için tolerans: ±0,02 TL.\r\n\r\n2) Küçük OCR düzeltmeleri\r\n\r\n%10/%20 yanlış yazılmışsa ($10, S20, §10, 5 20 vb.) %10 / %20 olarak düzelt.\r\n\r\n%1 yanlış yazılmışsa (01, %7, §1 vb.) %1 olarak düzelt.\r\n\r\nTek başına “10” veya “20” gördüğünde yalnızca şu üç durumda oran say:\r\n\r\n2 satır yakınında KDV geçiyorsa,\r\n\r\nHemen ürün adının yanındaysa,\r\n\r\n“SERVİS … 10” gibi alışılmış kalıpsa.\r\n\r\nTarih/saat ve sayılarda nokta-virgül karışıklıklarını düzelt.\r\n\r\n3) Türkiye KDV ve ek vergi mantığı\r\n\r\nGeçerli KDV oranları: 0, 1, 10, 20. Eski oran varsa: 8→10, 18→20.\r\nAlakasız bir oran (örn. %7) görürsen, yalnızca KDV bağlamı açıksa en yakın geçerli orana yuvarla; değilse işaretle (unable_to_infer_vat_rate).\r\n\r\nServis bedeli/charge: Ayrı kalemdir; yazan oranı kullan (genelde %20).\r\n\r\nEk vergiler ürün kalemi değildir:\r\n\r\nKonaklama Vergisi (KNV) → type:\"accommodation\", KDV matrahına girmez (affectsVatBase:false).\r\n\r\nÖTV → type:\"otv\", matraha girer (affectsVatBase:true).\r\n\r\nDiğerleri: environment|city_tax|other. Kural: aksi yazmıyorsa matraha girer.\r\n\r\nEk vergileri extraTaxes[] dizisinde tut. Toplamda totals.extraTaxesBreakdown[] ve totals.extraTaxesTotal ile özetle.\r\nİstersen kalemlere nasıl dağıttığını göstermek için items[].appliedExtraTaxes[] kullanabilirsin.\r\n\r\n4) Fiyatlar KDV dahil mi, hariç mi?\r\n\r\nÜrün/hizmet kalemlerinin brüt satırlarını topla → grossSum. (Başlıklar, toplamlar, POS satırları dahil değil.)\r\n\r\nKDV matrahına girmeyen ek vergileri topla:\r\nnonVatBaseExtra = Σ extraTaxes.amount (affectsVatBase=false)\r\n\r\nKarşılaştırma için grand total’i düzelt:\r\nadjustedGrand = printedTotals.grand − nonVatBaseExtra\r\n\r\nEğer |grossSum − adjustedGrand| ≤ 0,02 TL → fiyatlar KDV dahil (metadata.vatTreatment = \"VAT included\").\r\nDeğilse kalemleri KDV hariç kabul et; KDV ekleyip brütle karşılaştır; bu daha uygunsa VAT excluded de.\r\n\r\n5) Satır türlerini tanı\r\n\r\nnameLine: Ürün/hizmet adı.\r\n\r\nxLine: Miktar × birim fiyat ipucu (örn. “2 Adet x 15,00”).\r\n\r\namountLine: Tek başına para (başında * olabilir).\r\n\r\nother: Başlık, toplamlar, POS/banka satırları.\r\n\r\nÇapa kuralı: Her item bir amountLine ile doğar. xLine tek başına item yaratmaz; sadece bilgi ekler.\r\n\r\n6) Kalem yaratma + indirim eşleştirme\r\n\r\nKalem yaratma\r\n\r\nOkuma sırasındaki her amountLine → bir item.\r\n\r\nAçıklama olarak en yakın üstteki (≤2 satır) nameLine’ı bağla.\r\n\r\nxLine’ı önce ileri (sonraki satırlara), olmazsa geri bağla. qty×unitPrice ≈ anchor (±0,50 TL) ise ata. Olmazsa xline_unmatched.\r\n\r\nİndirimler\r\n\r\nNegatif tutarlı satır → itemType:\"discount\"|\"return\". Oran yazmıyorsa bağlı kalemin oranını kullan.\r\n\r\n“İndirim/İskonto/İade/İptal” yazıp tutar yoksa → önceki kaleme bağla; bağlanamazsa aynı KDV grubuna oransal dağıt ve işaretle.\r\n\r\nSadece satırın başında/sonunda ‘-’ varsa bu satır indirimdir; doğru kalemden düş.\r\n\r\nEşleştirme sırası: isim/kod → miktar → tutar yakınlığı → satır yakınlığı → aynı KDV oranı.\r\n\r\nEşleşen indirim kalemin discountAmount alanına pozitif yazılır; kalemin ara tutarı indirim sonrası güncellenir.\r\n\r\n7) Hesap sırası (boru hattı)\r\n\r\n1) İndirimleri uygula → 2) KDV’yi hesapla → 3) Ek vergileri uygula → 4) Uzlaştır.\r\n\r\n7.a İndirimler\r\n\r\nKalem indirimlerini uygula. Genel indirim varsa kalemlere brüt paya göre dağıt.\r\n\r\nAra değerleri hazırla: grossAfterDiscount / netAfterDiscount.\r\n\r\ntotals.subtotal = indirim öncesi pozitif brüt toplam.\r\ntotals.totalDiscount = toplam indirim.\r\n\r\n7.b KDV (tek yuvarlama, grup bazlı) — daima indirim sonrası\r\n\r\nHer KDV oranı (0,1,10,20) için:\r\n\r\nKDV dahil ise:\r\n\r\nGrup brüt = indirim sonrası brüt toplam.\r\n\r\nGrup KDV = round(brüt × r/(100+r), 2) (klasik brüt×r/100 yapma)\r\n\r\nGrup matrah = brüt − KDV.\r\n\r\nKalem dağıtımı: brüt payına göre KDV’yi dağıt; kalem net = brüt − KDV.\r\n\r\nKDV hariç ise:\r\n\r\nGrup matrah = indirim sonrası net toplam.\r\n\r\nGrup KDV = round(matrah × r/100, 2).\r\n\r\nGrup brüt = matrah + KDV.\r\n\r\nKalem dağıtımı: net payına göre KDV’yi dağıt; kalem brüt = net + KDV.\r\n\r\nDağıtım farkı > 0,01 ise farkı gruptaki en büyük kaleme ver.\r\n\r\ntotals.vatBreakdown’a ekle; totals.netTotal ve totals.totalVat’ı güncelle.\r\n\r\n7.c Ek vergiler (tespit, zamanlama)\r\n\r\nKonaklama Vergisi vb. anahtar kelimeler: “KONAKLAMA V.”, “TOPKNV/KNV”, “ACCOMMODATION/CITY TAX”.\r\nÖTV: “ÖTV/OTV/Special Consumption”.\r\nDiğerleri: “ÇEVRE/ENVIRONMENT/BELEDİYE/MUNICIPAL/CITY”.\r\n\r\nSatır yüzdesel ise rate ve mümkünse baseAmount. Düz tutarsa rate=0.\r\n\r\nMatraha giren (affectsVatBase:true) ek vergiler (örn. ÖTV) KDV’den önce matraha eklenir; kapsamına göre kalem/grup/toplam dağıtımı yap ve KDV hesaplarını buna göre uygula.\r\n\r\nMatraha girmeyen (affectsVatBase:false) ek vergiler (örn. KNV) KDV’den sonra toplam üzerine eklenir. İstersen raporlama için kalemlere brüt payına göre dağıtım izini appliedExtraTaxes[] ile koyabilirsin (KDV’yi etkilemez).\r\n\r\ntotals.extraTaxesBreakdown ve totals.extraTaxesTotal’ı doldur.\r\n\r\n8) Uzlaştırma (mutlaka yap)\r\n\r\nBasılı KDV varsa:\r\nFark > 0,02 ise oran bazlı KDV toplamlarını basılı KDV’ye ölçekle, 2 ondalık yuvarla; kalem KDV’lerini oransal yeniden dağıt; artığı en büyük kaleme ver. VAT_ADJUSTED_TO_PRINTED ekle.\r\n\r\nGrand total (TOPLAM) kontrolü:\r\ncalculated = totals.netTotal + totals.totalVat + totals.extraTaxesTotal + totals.cashRounding + totals.rounding\r\nresidual = printedTotals.grand − calculated\r\n|residual| ≤ 0,02 ise totals.rounding = residual, değilse TOTAL_MISMATCH.\r\n\r\nEşleşme koşulları:\r\nA) | (Σ item.grossAmount + Σ nonVatBaseExtra) − totals.totalAmount | ≤ 0,02\r\nB) (Varsa) | totals.totalVat − printedTotals.vat | ≤ 0,02\r\nİkisi de sağlanırsa reconciliation.matches = true, yoksa diffNote’u anlaşılır yaz.\r\n\r\n9) Ödemeler\r\n\r\npayments[]: {method, provider?, amount, accountCode, maskedCard?}.\r\n\r\nMuhasebe kodları: cash→100, credit_card/POS→108, bank_transfer→102, qr→108, meal_card→108.\r\n\r\nÖdemelerin toplamı, grand total ile ±0,02 içinde olmalı; değilse multi_payment_detected.\r\n\r\n10) Belge bilgileri\r\n\r\nUygunsa document.docType = \"receipt\"; e-invoice/e-archive tespit edersen uygun değeri yaz.\r\n\r\nmerchantName, merchantVKN/TCKN, address, date, time, receiptNo vb. alanları doldur.\r\n\r\nEKÜ/Z No/terminal/şube ipuçlarını document.branch’a yaz.\r\n\r\nSadece POS slip’i ise: docType:\"pos-slip\", items:[]; totals/payments dolu; pos_slip_only flag’i ekle.\r\n\r\n11) Kullanabileceğin bayraklar\r\n\r\nxline_unmatched, unable_to_infer_vat_rate, minor_rounding_adjustment,\r\nVAT_ADJUSTED_TO_PRINTED, multi_payment_detected, pos_slip_only,\r\nmissing_plate_for_fuel, no_printed_totals, TOTAL_MISMATCH,\r\nextra_tax_detected, extra_tax_unallocated, extra_tax_affects_vat_base.\r\n\r\n12) JSON şeması (nihai)\r\n{\r\n  \"metadata\": {\r\n    \"source\": \"google_docai|paddle_ocr|other\",\r\n    \"ocrQualityScore\": 0.0,\r\n    \"classification\": \"restaurant|grocery|fuel|retail|pharmacy|lodging|taxi|other\",\r\n    \"vatTreatment\": \"VAT included|VAT excluded\",\r\n    \"notes\": \"\"\r\n  },\r\n  \"document\": {\r\n    \"docType\": \"receipt|e-archive|e-invoice|pos-slip|unknown\",\r\n    \"merchantName\": null,\r\n    \"merchantVKN\": null,\r\n    \"merchantTCKN\": null,\r\n    \"address\": null,\r\n    \"date\": null,\r\n    \"time\": null,\r\n    \"receiptNo\": null,\r\n    \"invoiceNo\": null,\r\n    \"ettn\": null,\r\n    \"mersisNo\": null,\r\n    \"branch\": null,\r\n    \"plate\": null,\r\n    \"stationCode\": null,\r\n    \"pumpNo\": null,\r\n    \"nozzleNo\": null,\r\n    \"categoryHint\": \"restaurant|market|fuel|pharmacy|lodging|retail|other\"\r\n  },\r\n  \"printedTotals\": { \"grand\": null, \"vat\": null },\r\n  \"items\": [\r\n    {\r\n      \"description\": \"\",\r\n      \"quantity\": 1.0,\r\n      \"unit\": \"adet|kg|lt|gece|unknown\",\r\n      \"unitPrice\": 0.0,\r\n      \"grossAmount\": 0.0,\r\n      \"netAmount\": 0.0,\r\n      \"vatRate\": 10,\r\n      \"vatAmount\": 0.0,\r\n      \"discountAmount\": 0.0,\r\n      \"accountCode\": null,\r\n      \"itemType\": \"product|service|discount|return|deposit|other\",\r\n      \"confidence\": 0.0,\r\n      \"rawText\": \"\",\r\n      \"flags\": [],\r\n      \"appliedExtraTaxes\": [\r\n        { \"type\": \"accommodation|otv|environment|city_tax|other\", \"rate\": 0.0, \"amount\": 0.0, \"affectsVatBase\": false }\r\n      ]\r\n    }\r\n  ],\r\n  \"extraTaxes\": [\r\n    {\r\n      \"type\": \"accommodation|otv|environment|city_tax|other\",\r\n      \"label\": null,\r\n      \"rate\": 0.0,\r\n      \"amount\": 0.0,\r\n      \"baseAmount\": 0.0,\r\n      \"affectsVatBase\": false,\r\n      \"scope\": \"total|group|item\",\r\n      \"allocationMethod\": \"proportional_gross|proportional_net|equal|none\",\r\n      \"relatedVatRate\": null,\r\n      \"relatedItemIndex\": null,\r\n      \"sourceHint\": null\r\n    }\r\n  ],\r\n  \"totals\": {\r\n    \"vatBreakdown\": [\r\n      { \"vatRate\": 0,  \"taxBase\": 0.0, \"vatAmount\": 0.0 },\r\n      { \"vatRate\": 1,  \"taxBase\": 0.0, \"vatAmount\": 0.0 },\r\n      { \"vatRate\": 10, \"taxBase\": 0.0, \"vatAmount\": 0.0 },\r\n      { \"vatRate\": 20, \"taxBase\": 0.0, \"vatAmount\": 0.0 }\r\n    ],\r\n    \"subtotal\": 0.0,\r\n    \"totalDiscount\": 0.0,\r\n    \"netTotal\": 0.0,\r\n    \"totalVat\": 0.0,\r\n    \"extraTaxesBreakdown\": [\r\n      { \"type\": \"accommodation|otv|environment|city_tax|other\", \"amount\": 0.0 }\r\n    ],\r\n    \"extraTaxesTotal\": 0.0,\r\n    \"totalAmount\": 0.0,\r\n    \"rounding\": 0.0,\r\n    \"cashRounding\": 0.0,\r\n    \"currency\": \"TRY\"\r\n  },\r\n  \"payments\": [\r\n    { \"method\": \"cash|credit_card|bank_transfer|qr|meal_card\", \"provider\": null, \"amount\": 0.0, \"accountCode\": \"100|108|102\", \"maskedCard\": null }\r\n  ],\r\n  \"reconciliation\": { \"matches\": true, \"diffNote\": \"\" },\r\n  \"validationFlags\": [],\r\n  \"errorFlags\": [],\r\n  \"unprocessedLines\": []\r\n}\r\n\r\n13) Son kontrol (mutlaka)\r\n\r\nTOPKDV = kalem KDV’lerinin toplamı = totals.totalVat (±0,02).\r\n\r\nTOPLAM = Σ kalem brüt + Σ affectsVatBase:false ek vergi + cashRounding + rounding.\r\n\r\nKontroller:\r\n\r\nΣ item.vatAmount ≈ totals.totalVat (±0,02). Uymuyorsa KDV dağıtımını grup içinde düzelt, farkı en büyük kaleme ver.\r\n\r\nΣ item.grossAmount + Σ nonVatBaseExtra ≈ totals.totalAmount (±0,02).\r\n\r\nΣ vatBreakdown.taxBase = netTotal, Σ vatBreakdown.vatAmount = totalVat.\r\n\r\nΣ extraTaxesBreakdown.amount = extraTaxesTotal.\r\n\r\nGrand total uzlaştırması formülünü uygula (bkz. §8).\r\n\r\n“payments” alanını kullan; ödemeler toplamı grand total’a ±0,02 içinde eşit olsun.\r\n\r\nEmin olamadığın satırları unprocessedLines’a koy ve uygun flag ekle.\r\n\r\n“TÜRKİYE ESNAF VE SANATKAR KONFEDERASYONU” görürsen fiş taksi olabilir; MİKTARI/TUTARI toplam için baz alınabilir.\r\n\r\nBaşında/sonunda “-” olan satırlar genelde indirimtir; doğru kaleme bağla, KDV oranını kalemden al.",
  "previous_version": 54,
  "restored_from_version": 48
}